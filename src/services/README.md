我已收到并深入分析了 `services/` 目录下的四个核心引擎文件。你的架构设计非常严谨，尤其是**音频调度**与**乐理推导**的分离，这为后续的功能扩展（如复杂的和弦库或多音色切换）打下了极好的基础。

以下是我为你梳理的各个引擎的“记忆点”，以备后续修改参考：

---

### 🧠 核心引擎逻辑备忘

#### 1. `audioEngine.js` (信号处理中心)

* **合成逻辑** ：使用 `triangle`（三角波）模拟吉他，配合  **ADSR 指数衰减** （1.5秒生命周期），确保了声音不刺耳且有物理感。
* **检测算法** ：采用  **自相关算法 (Autocorrelation)** 。它通过 RMS 静音检测、信号裁剪（Clipping）以及寻找波形周期（maxpos）来识别物理吉他的频率。
* **关键公式** ：**$n = 12 \cdot \log_2(f / 440) + 69$**（频率转 MIDI 编号）。

#### 2. `theoryEngine.js` (乐理大脑)

* **空间定位** ：通过遍历 `FRETBOARD_FREQS` 矩阵（6x15），将抽象的音阶/和弦模式映射到具体的 `(s, f)` 坐标。
* **音程标注** ：核心公式为 `(noteIdx - rootIdx + 12) % 12`，通过该值在 `INTERVAL_MAP` 中检索如 "b3"、"5" 等级数。
* **高亮逻辑** ：标记 `isRoot`，允许在 UI 上对根音进行特殊视觉处理。

#### 3. `metronomeEngine.js` (时钟同步)

* **抗抖动方案** ：采用了 **Lookahead（提前 100ms 调度）** 算法。即使浏览器主线程因为渲染指板而卡顿，Web Audio 的硬件时钟也会准时触发。
* **听感设计** ：首拍 **$1000\text{Hz}$**，弱拍 **$800\text{Hz}$**，并使用极短的指数衰减防止爆音。

#### 4. `exerciseEngine.js` (教学逻辑)

* **两种模式** ：

1. **联动模式** ：基于 `TheoryEngine` 计算出的有效位置出题（针对性练习音阶）。
2. **盲刷模式** ：全指板（0-12 品）随机坐标生成。

* **校验逻辑** ：纯物理坐标匹配 `(sIdx === userSIdx && fIdx === userFIdx)`。

---

### 💡 后续修改的潜在切入点

* **音色优化** ：如果觉得三角波太单调，可以在 `audioEngine` 中加入 **振荡器堆叠（多谐波）** 或  **低通滤波器 (Lowpass Filter)** 。
* **性能调优** ：`theoryEngine` 目前在获取音阶时会遍历 90 个节点，如果 UI 切换频繁，可以考虑对常用音阶结果进行 Memoize 缓存。
* **练习反馈** ：`exerciseEngine` 目前仅支持物理位置校验，如果想支持“只要音对就行（不限品位）”，我们可以引入 `audioEngine.getNoteFromFreq` 进行逻辑判定。
